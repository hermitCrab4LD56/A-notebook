import { hilog } from '@kit.PerformanceAnalysisKit';
import { router } from '@kit.ArkUI';

const DOMAIN = 0x0000;

@Entry
@Component
struct Index {
  @State selectedTrack: number = 2; // å½“å‰é€‰ä¸­çš„è½¨é“
  @State playingTrack: number = -1; // å½“å‰æ’­æ”¾çš„è½¨é“
  @State waveformData: number[] = []; // æ³¢å½¢æ•°æ®
  
  // æœç´¢ç›¸å…³çŠ¶æ€
  @State isSearchActive: boolean = false; // æœç´¢æ˜¯å¦æ¿€æ´»
  @State searchText: string = ''; // æœç´¢æ–‡æœ¬
  @State searchHovered: boolean = false; // æœç´¢å›¾æ ‡æ‚¬åœçŠ¶æ€
  @State searchPressed: boolean = false; // æœç´¢å›¾æ ‡æŒ‰ä¸‹çŠ¶æ€
  
  // æœ€å¤§åŒ–ç›¸å…³çŠ¶æ€
  @State isMaximized: boolean = false; // ä¾§è¾¹æ æ˜¯å¦æœ€å¤§åŒ–
  
  // èœå•ç›¸å…³çŠ¶æ€
  @State menuHovered: boolean = false; // èœå•å›¾æ ‡æ‚¬åœçŠ¶æ€
  @State menuPressed: boolean = false; // èœå•å›¾æ ‡æŒ‰ä¸‹çŠ¶æ€
  
  // æœç´¢ç»“æœ
  @State searchResults: string[] = []; // æœç´¢ç»“æœåˆ—è¡¨
  
  // æ‰€æœ‰å¯æœç´¢çš„æ–‡æœ¬å†…å®¹
  private allSearchableTexts: string[] = [
    'default',
    'Mockup Date 1',
    'Mockup Date 2', 
    'Mockup Date 3',
    'new group'
  ];

  build() {
    Row() {
      // ä¾§è¾¹æ 
      this.Sidebar()

      // ä¸»å†…å®¹åŒº - æ ¹æ®æœ€å¤§åŒ–çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤º
      if (!this.isMaximized) {
        this.MainContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1F2937')
  }

  @Builder
  Sidebar() {
    Column() {
      // ä¾§è¾¹æ å¤´éƒ¨
      this.SidebarHeader()

      // æ–‡ä»¶/ç¬”è®°æœ¬éƒ¨åˆ†
      this.NotebookSection()
    }
    .width(this.isMaximized ? '100%' : 200)
    .height('100%')
    .backgroundColor('#374151')
    .border({ width: { right: this.isMaximized ? 0 : 1 }, color: '#4B5563' })
  }

  @Builder
  SidebarHeader() {
    Row() {
      // èœå•å›¾æ ‡å®¹å™¨
      Row() {
        Text('â‰¡')
          .fontSize(18)
          .fontColor('#9CA3AF')
      }
      .width(32)
      .height(32)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.menuHovered || this.menuPressed ? '#4B5563' : Color.Transparent)
      .borderRadius(4)
      .onHover((isHover: boolean) => {
        this.menuHovered = isHover;
      })
      .onTouch((event: TouchEvent) => {
        if (event.type === TouchType.Down) {
          this.menuPressed = true;
        } else if (event.type === TouchType.Up) {
          this.menuPressed = false;
          this.toggleMaximize();
        }
      })

      // æœç´¢æ¡† - ä»…åœ¨æœç´¢æ¿€æ´»æ—¶æ˜¾ç¤º
      if (this.isSearchActive) {
        TextInput({ placeholder: 'æœç´¢...', text: this.searchText })
          .width(80)
          .height(32)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#4B5563')
          .borderRadius(4)
          .padding({ left: 8, right: 8 })
          .placeholderColor('#9CA3AF')
          .onChange((value: string) => {
            this.searchText = value;
            this.performSearch(value);
          })
          .margin({ left: 4, right: 4 })
      } else {
        Blank()
      }

      // æœç´¢å›¾æ ‡
      Row() {
        Image($r('app.media.search_icon'))
          .width(18)
          .height(17)
          .fillColor('#9CA3AF')
      }
      .width(32)
      .height(32)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.searchHovered || this.searchPressed ? '#4B5563' : Color.Transparent)
      .borderRadius(4)
      .onHover((isHover: boolean) => {
        this.searchHovered = isHover;
      })
      .onTouch((event: TouchEvent) => {
        if (event.type === TouchType.Down) {
          this.searchPressed = true;
        } else if (event.type === TouchType.Up) {
          this.searchPressed = false;
          this.toggleSearch();
        }
      })
    }
    .width('100%')
    .height(48)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#374151')
  }

  @Builder
  NotebookSection() {
    Column({ space: 16 }) {
      if (this.isSearchActive) {
        // æœç´¢æ¨¡å¼ - æ˜¾ç¤ºæœç´¢ç»“æœ
        if (this.searchResults.length > 0) {
          ForEach(this.searchResults, (result: string) => {
            this.SearchResultItem(result)
          })
        } else if (this.searchText.length > 0) {
          // æ— æœç´¢ç»“æœ
          Text('æ— åŒ¹é…ç»“æœ')
            .fontSize(14)
            .fontColor('#9CA3AF')
            .margin({ top: 20 })
        }
      } else {
        // æ­£å¸¸æ¨¡å¼ - æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
        // default ç¬”è®°æœ¬
        this.NotebookItem('default', true, false)

        // defaultç¬”è®°æœ¬ä¸‹çš„æ–‡ä»¶åˆ—è¡¨
        Column({ space: 4 }) {
          this.FileItem('Mockup Date 1', false, $r('app.color.accent_purple'))
          this.FileItem('Mockup Date 2', false, $r('app.color.accent_purple'))
          this.FileItem('Mockup Date 3', true, $r('app.color.accent_green'))
        }
        .padding({ left: this.isMaximized ? 24 : 12, right: this.isMaximized ? 24 : 12 })
        .alignItems(this.isMaximized ? HorizontalAlign.Center : HorizontalAlign.Start)

        // new group ç¬”è®°æœ¬
        this.NotebookItem('new group', false, false)
      }
    }
    .width('100%')
    .padding(this.isMaximized ? 24 : 12)
    .alignItems(this.isMaximized ? HorizontalAlign.Center : HorizontalAlign.Start)
  }

  @Builder
  NotebookItem(name: string, isDefault: boolean, isSelected: boolean) {
    Row({ space: 8 }) {
      // ç¬”è®°æœ¬å›¾æ ‡
      Image($r('app.media.icon'))
        .width(16)
        .height(16)
        .fillColor($r('app.color.accent_red'))

      Text(name)
        .fontSize(this.isMaximized ? 16 : 14)
        .fontColor($r('app.color.text_secondary'))
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
    }
    .width('100%')
    .padding({
      left: this.isMaximized ? 8 : 4,
      right: this.isMaximized ? 8 : 4,
      top: this.isMaximized ? 12 : 8,
      bottom: this.isMaximized ? 12 : 8
    })
    .backgroundColor(isSelected ? $r('app.color.background_tertiary') : Color.Transparent)
    .borderRadius(4)
    .justifyContent(this.isMaximized ? FlexAlign.Center : FlexAlign.Start)
  }

  @Builder
  FileItem(name: string, isSelected: boolean, dotColor: Resource) {
    Row({ space: 8 }) {
      // çŠ¶æ€ç‚¹
      Circle({ width: this.isMaximized ? 10 : 8, height: this.isMaximized ? 10 : 8 })
        .fill(dotColor)

      Text(name)
        .fontSize(this.isMaximized ? 16 : 14)
        .fontColor($r('app.color.text_secondary'))
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
    }
    .width('100%')
    .padding({
      left: this.isMaximized ? 16 : 8,
      right: this.isMaximized ? 16 : 8,
      top: this.isMaximized ? 8 : 4,
      bottom: this.isMaximized ? 8 : 4
    })
    .backgroundColor(isSelected ? $r('app.color.background_tertiary') : Color.Transparent)
    .borderRadius(4)
    .justifyContent(this.isMaximized ? FlexAlign.Center : FlexAlign.Start)
  }

  @Builder
  SearchResultItem(result: string) {
    Row({ space: 8 }) {
      // æœç´¢ç»“æœå›¾æ ‡
      if (result === 'default' || result === 'new group') {
        Image($r('app.media.icon'))
          .width(16)
          .height(16)
          .fillColor($r('app.color.accent_red'))
      } else {
        Circle({ width: 8, height: 8 })
          .fill($r('app.color.accent_purple'))
      }

      // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ–‡æœ¬
      this.HighlightText(result, this.searchText)
    }
    .width('100%')
    .padding({
      left: 8,
      right: 8,
      top: 6,
      bottom: 6
    })
    .backgroundColor('#4B5563')
    .borderRadius(4)
  }

  @Builder
  HighlightText(fullText: string, searchText: string) {
    if (searchText.length === 0) {
      Text(fullText)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
    } else {
      Row() {
        Text(fullText)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
    }
  }

  @Builder
  MainContent() {
    Column() {
      // å¤´éƒ¨æ ‡é¢˜
      this.MainHeader()

      // éŸ³é¢‘è½¨é“åˆ—è¡¨
      this.AudioTracksList()
    }
    .layoutWeight(1)
    .height('100%')
    .backgroundColor('#1F2937')
    .padding(24)
  }

  @Builder
  MainHeader() {
    Column({ space: 12 }) {
      Row() {
        Text('Mockup Date 3')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')

        Blank()

        // ä¸‰ä¸ªç‚¹èœå•
        Text('â‹¯')
          .fontSize(20)
          .fontColor('#9CA3AF')
          .onClick(() => {
            try {
              router.pushUrl({ url: 'pages/UpdateNotebookLabels' });
            } catch (error) {
              hilog.error(DOMAIN, 'testTag', 'Failed to navigate to UpdateNotebookLabels: %{public}s', JSON.stringify(error));
            }
          })
      }
      .width('100%')
    }
    .width('100%')
    .margin({ bottom: 24 })
  }

  @Builder
  AudioTracksList() {
    Column({ space: 12 }) {
      this.AudioTrackItem($r('app.string.audio_track_1_duration').toString(), 0, this.playingTrack === 0)
      this.AudioTrackItem($r('app.string.audio_track_2_duration').toString(), 1, this.playingTrack === 1)
      this.AudioTrackItem($r('app.string.audio_track_3_duration').toString(), 2, this.playingTrack === 2)
      this.AudioTrackItem($r('app.string.audio_track_4_duration').toString(), 3, this.playingTrack === 3)
    }
    .width('100%')
  }

  @Builder
  AudioTrackItem(duration: string, trackIndex: number, isPlaying: boolean) {
    Row({ space: 16 }) {
      // éŸ³é‡å›¾æ ‡
      Text('ğŸ”Š')
        .fontSize(16)
        .fontColor(isPlaying ? '#10B981' : '#D1D5DB')

      // æ³¢å½¢å¯è§†åŒ–
      this.WaveformVisualization(trackIndex)

      // æ—¶é•¿
      Text(duration)
        .fontSize(14)
        .fontColor('#D1D5DB')
    }
    .width('100%')
    .height(56)
    .padding(16)
    .backgroundColor('#4B5563')
    .borderRadius(8)
    .onClick(() => {
      this.playingTrack = isPlaying ? -1 : trackIndex;
    })
  }

  @Builder
  WaveformVisualization(trackIndex: number) {
    Row({ space: 2 }) {
      ForEach([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39], (item: number) => {
        Column()
          .width(2)
          .height(this.getWaveformHeight(trackIndex, item))
          .backgroundColor(this.playingTrack === trackIndex ? '#10B981' : '#9CA3AF')
          .borderRadius(1)
      })
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ç”Ÿæˆæ³¢å½¢é«˜åº¦æ•°æ®
  private getWaveformHeight(trackIndex: number, barIndex: number): number {
    // ä¸ºæ¯ä¸ªè½¨é“ç”Ÿæˆå›ºå®šçš„æ³¢å½¢æ•°æ®
    const baseHeight = 8;
    const variation = 16;
    const seed = trackIndex * 20 + barIndex;
    return baseHeight + (Math.sin(seed * 0.3) * variation * 0.5 + variation * 0.5);
  }

  // åˆ‡æ¢æœç´¢çŠ¶æ€
  private toggleSearch(): void {
    this.isSearchActive = !this.isSearchActive;
    if (!this.isSearchActive) {
      // å…³é—­æœç´¢æ—¶æ¸…ç©ºæœç´¢å†…å®¹
      this.searchText = '';
      this.searchResults = [];
    }
  }

  // æ‰§è¡Œæœç´¢
  private performSearch(searchText: string): void {
    if (searchText.trim().length === 0) {
      this.searchResults = [];
      return;
    }

    const lowerSearchText = searchText.toLowerCase();
    this.searchResults = this.allSearchableTexts.filter(text => 
      text.toLowerCase().includes(lowerSearchText)
    );
  }

  // åˆ‡æ¢æœ€å¤§åŒ–çŠ¶æ€
  private toggleMaximize(): void {
    this.isMaximized = !this.isMaximized;
  }



  aboutToAppear() {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Audio Notebook App started');
  }
}